import { bO as u, bW as v, dS as c, h as h$1, bk as c$2, b$ as y, b8 as e$1 } from './vec2f32-a88eee2e.js';
import { h, C as C$1, aA as c$1 } from './intl-f9bcf179.js';
import { I as I$1, q } from './cimAnalyzer-65b5b691.js';
import { c as s$1, s as s$2 } from './CIMSymbolHelper-18d731f4.js';
import { m } from './Rasterizer-61f238c4.js';
import { n as n$1, e, r } from './utils-86b5682d.js';
import { m as m$1, n as n$2, i } from './utils-0c74ca00.js';
import { l } from './renderUtils-07297792.js';
import './JSONSupport-add604e3.js';
import './quantizationUtils-9e335e8b.js';
import './shapingUtils-2219035b.js';
import './Rect-988189d5.js';
import './number-237bc27c.js';
import './definitions-08701efa.js';
import './GeometryUtils-93aa6536.js';
import './BlendLayer-324633cc.js';
import './mat4-ae511675.js';
import './_commonjsHelpers-020ca939.js';
import './ItemCache-f1121cd2.js';
import './MemCache-cd2cb7cb.js';
import './colorUtils-a7d03078.js';
import './accessibleHandler-756590a8.js';
import './Handles-c08f164d.js';
import './uuid-917a1a17.js';
import './watchUtils-47c42485.js';
import './index-5d892dab.js';

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
var M;!function(e){e.Legend="legend",e.Preview="preview";}(M||(M={}));const C=(e,t,r)=>{if(e&&e.targetSize){let i;if(r){const t=Math.max(r.frame.xmax-r.frame.xmin,r.frame.ymax-r.frame.ymin);i=e.targetSize/u(t);}else i=e.targetSize/t.referenceSize;return i}return e&&e.scaleFactor?e.scaleFactor:1},I={fill:{legend:{frame:{xmax:15,xmin:0,ymax:15,ymin:0},geometry:{rings:[[[0,15],[15,7.5],[15,0],[0,0],[0,15]]]},canvasPaths:{rings:[[[0,15],[0,0],[15,7.5],[15,15],[0,15]]]}},preview:{frame:{xmax:100,xmin:0,ymax:100,ymin:0},geometry:{rings:[[[0,100],[100,100],[100,0],[0,0],[0,100]]]},canvasPaths:{rings:[[[0,100],[0,0],[100,0],[100,100],[0,100]]]}}},stroke:{legend:{frame:{xmax:24,xmin:0,ymax:2,ymin:-2},geometry:{paths:[[[0,0],[12,0],[24,0]]]},canvasPaths:{paths:[[[0,2],[12,2],[24,2]]]}},preview:{frame:{xmax:100,xmin:0,ymax:2,ymin:-2},geometry:{paths:[[[0,0],[50,0],[100,0]]]},canvasPaths:{paths:[[[0,2],[50,2],[100,2]]]}}}};class z{constructor(e,t){this._spatialReference=e,this._avoidSDF=t,this._resourceCache=new Map,this._pictureMarkerCache=new Map,this._textRasterizer=new s$1,this._cimResourceManager=new s$2,this._rasterizer=new m(this._cimResourceManager);}async rasterizeCIMSymbolAsync(e,t,r,a,i,o,n,c){a=a||(t?null!=t.centroid?"esriGeometryPolygon":v(t.geometry):null)||P(e);const l=await this.analyzeCIMSymbol(e,t?x(t.attributes):null,r,a,c);return this.rasterizeCIMSymbol(l,t,a,i,o,n)}async analyzeCIMSymbol(e,t,a,i,s){const o=[],n=t?{geometryType:i,spatialReference:this._spatialReference,fields:t}:null;let l;await I$1(e.data,n,this._cimResourceManager,o,this._avoidSDF),h(s);for(const r of o)"CIMPictureMarker"!==r.cim.type&&"CIMPictureFill"!==r.cim.type&&"CIMPictureStroke"!==r.cim.type||(l||(l=[]),l.push(this.fetchPictureMarkerResource(r,s))),a&&"text"===r.type&&"string"==typeof r.text&&r.text.indexOf("[")>-1&&(r.text=n$1(a,r.text,r.cim.textCase));return l&&await Promise.all(l),o}async fetchPictureMarkerResource(e,r){const a=e.materialHash;if(!this._pictureMarkerCache.get(a)){const i=(await C$1(e.cim.url,{responseType:"image",signal:r&&r.signal})).data;this._pictureMarkerCache.set(a,i);}}rasterizeCIMSymbol(e$1,t,r,a,i,s){const o=[];for(const n of e$1){a&&"function"==typeof a.scaleFactor&&(a.scaleFactor=a.scaleFactor(t,i,s));const e$1=this._getRasterizedResource(n,t,r,a,i,s);if(!e$1)continue;let c=0,l=e$1.anchorX||0,m=e$1.anchorY||0,h=!1,f=0,g=0;if("esriGeometryPoint"===r){const e$1=C(a,n,null);if(f=e(n.offsetX,t,i,s)*e$1||0,g=e(n.offsetY,t,i,s)*e$1||0,"marker"===n.type)c=e(n.rotation,t,i,s)||0,h=!!n.rotateClockwise&&n.rotateClockwise;else if("text"===n.type){if(c=e(n.angle,t,i,s)||0,void 0!==n.horizontalAlignment)switch(n.horizontalAlignment){case"left":l=-.5;break;case"right":l=.5;break;default:l=0;}if(void 0!==n.verticalAlignment)switch(n.verticalAlignment){case"top":m=.5;break;case"bottom":m=-.5;break;case"baseline":m=-.25;break;default:m=0;}}}null!=e$1&&o.push({angle:c,rotateClockWise:h,anchorX:l,anchorY:m,offsetX:f,offsetY:g,rasterizedResource:e$1});}return this.getSymbolImage(o)}getSymbolImage(e){const t=document.createElement("canvas"),r=t.getContext("2d");let i=0,s=0,o=0,n=0;const c$1=[];for(let f=0;f<e.length;f++){const t=e[f],l=t.rasterizedResource;if(!l)continue;const m=l.size,h=t.offsetX,g=t.offsetY,y=t.anchorX,u$1=t.anchorY,p=t.rotateClockWise||!1;let d=t.angle,M=u(h)-m[0]*(.5+y),C=u(g)-m[1]*(.5+u$1),I=M+m[0],z=C+m[1];if(d){p&&(d=-d);const e=Math.sin(d*Math.PI/180),t=Math.cos(d*Math.PI/180),r=M*t-C*e,a=M*e+C*t,i=M*t-z*e,s=M*e+z*t,o=I*t-z*e,n=I*e+z*t,c=I*t-C*e,l=I*e+C*t;M=Math.min(r,i,o,c),C=Math.min(a,s,n,l),I=Math.max(r,i,o,c),z=Math.max(a,s,n,l);}i=M<i?M:i,s=C<s?C:s,o=I>o?I:o,n=z>n?z:n;const x=r.createImageData(l.size[0],l.size[1]);x.data.set(new Uint8ClampedArray(l.image.buffer));const P={offsetX:h,offsetY:g,rotateClockwise:p,angle:d,rasterizedImage:x,anchorX:y,anchorY:u$1};c$1.push(P);}t.width=o-i,t.height=n-s;const l=-i,m=n;for(let f=0;f<c$1.length;f++){const e=c$1[f],t=this._imageDataToCanvas(e.rasterizedImage),i=e.rasterizedImage.width,s=e.rasterizedImage.height,o=l-i*(.5+e.anchorX),n=m-s*(.5-e.anchorY);if(e.angle){const i=(360-e.angle)*Math.PI/180;r.save(),r.translate(u(e.offsetX),-u(e.offsetY)),r.translate(l,m),r.rotate(i),r.translate(-l,-m),r.drawImage(t,o,n),r.restore();}else r.drawImage(t,o+u(e.offsetX),n-u(e.offsetY));}const h=new c({x:l/t.width-.5,y:m/t.height-.5});return {imageData:0!==t.width&&0!==t.height?r.getImageData(0,0,t.width,t.height):r.createImageData(1,1),anchorPosition:h}}_imageDataToCanvas(e){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const t=this._imageDataCanvas,r=t.getContext("2d");return t.width=e.width,t.height=e.height,r.putImageData(e,0,0),t}_imageTo32Array(t,r,a,i){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const s=this._imageDataCanvas,o=s.getContext("2d");if(s.width=r,s.height=a,o.drawImage(t,0,0,r,a),i){o.save();const s=new h$1(i);o.fillStyle=s.toHex(),o.globalCompositeOperation="multiply",o.fillRect(0,0,r,a),o.globalCompositeOperation="destination-atop",o.drawImage(t,0,0,r,a),o.restore();}return new Uint32Array(o.getImageData(0,0,r,a).data.buffer)}_getRasterizedResource(e$1,t,r,a,s,o){let n,c,l,m,h=null,f=null;if("esriGeometryPolyline"===r||"esriGeometryPolygon"===r){const m=a&&a.style?a.style:M.Legend,g="esriGeometryPolyline"===r?I.stroke[m]:I.fill[m];if("line"===e$1.type){if("CIMSolidStroke"!==e$1.cim.type){if("CIMPictureStroke"===e$1.cim.type){const r=e(e$1.width,t,s,o),a=e(e$1.color,t,s,o),{image:i,width:n,height:c}=this._getPictureResource(e$1,r,a);return this._rasterizePictureResource(e$1,i,n,c,g,r)}return null}({analyzedCIM:n,hash:l}=w(e$1,t,s,o)),c=this._embedCIMLayerInVectorMarker(n,g);}else if("marker"===e$1.type){if("CIMPictureMarker"===e$1.cim.type)return null;if("CIMVectorMarker"!==e$1.cim.type)return null;e$1.cim.offsetX=e(e$1.offsetX,t,s,o),e$1.cim.offsetY=e(e$1.offsetY,t,s,o),e$1.cim.rotation=e(e$1.rotation,t,s,o),e$1.cim.markerPlacement=e$1.markerPlacement,({analyzedCIM:n}=w(e$1,t,s,o)),l=c$1(JSON.stringify(n)).toString(),c=this._embedCIMLayerInVectorMarker(n,g),h=e(e$1.size,t,s,o),f=e$1.path;}else {if("text"===e$1.type)return null;if("fill"===e$1.type){if("CIMHatchFill"===e$1.cim.type||"CIMVectorMarker"===e$1.cim.type||"CIMPictureMarker"===e$1.cim.type||"CIMPictureFill"===e$1.cim.type){const r=e$1.cim.size||e$1.cim.height;let a,i,c;if("CIMPictureMarker"===e$1.cim.type||"CIMPictureFill"===e$1.cim.type)({image:a,width:i,height:c}=this._getPictureResource(e$1,r,e(e$1.color,t,s,o)));else {({analyzedCIM:n,hash:l}=w(e$1,t,s,o));const m=this._rasterizer.rasterizeJSONResource({cim:n,type:e$1.type,url:e$1.url,mosaicHash:l,size:r,path:f},1,this._avoidSDF);a=m.image,i=m.size[0],c=m.size[1];}return this._rasterizePictureResource(e$1,a,i,c,g,null)}if("CIMSolidFill"!==e$1.cim.type)return null;({analyzedCIM:n,hash:l}=w(e$1,t,s,o)),c=this._embedCIMLayerInVectorMarker(n,g);}}}else {if("text"===e$1.type)return m=this._rasterizeTextResource(e$1,t,a,s,o),m;({analyzedCIM:n,hash:l}=w(e$1,t,s,o));const r=C(a,e$1,null);if("CIMPictureMarker"===e$1.cim.type){const a=e(e$1.size,t,s,o)*r,{image:i,width:n,height:c}=this._getPictureResource(e$1,a,e(e$1.color,t,s,o));return m={image:i,size:[n,c],sdf:!1,simplePattern:!1,anchorX:e$1.anchorPoint?e$1.anchorPoint.x:0,anchorY:e$1.anchorPoint?e$1.anchorPoint.y:0},m}m$1(n,r,{preserveOutlineWidth:!1}),c=n;}l+=r,a&&(l+=JSON.stringify(a));const g=this._resourceCache;return g.has(l)?g.get(l):(m=this._rasterizer.rasterizeJSONResource({cim:c,type:e$1.type,url:e$1.url,mosaicHash:l,size:h,path:f},window.devicePixelRatio||1,this._avoidSDF),g.set(l,m),m)}_rasterizeTextResource(e$1,t,r$1,a,i){const s=C(r$1,e$1,null),o=e(e$1.text,t,a,i);if(!o||0===o.length)return null;const n=e(e$1.fontName,t,a,i),c=e(e$1.style,t,a,i),l=e(e$1.weight,t,a,i),m=e(e$1.decoration,t,a,i),h=e(e$1.size,t,a,i)*s,f=e(e$1.horizontalAlignment,t,a,i),g=e(e$1.verticalAlignment,t,a,i),p=r(e(e$1.color,t,a,i)),d=r(e(e$1.outlineColor,t,a,i)),M={color:p,size:h,horizontalAlignment:f,verticalAlignment:g,font:{family:n,style:c,weight:l,decoration:m},halo:{size:e(e$1.outlineSize,t,a,i)||0,color:d,style:c},pixelRatio:1,premultiplyColors:!this._avoidSDF};return this._textRasterizer.rasterizeText(o,M)}_rasterizePictureResource(e,t,r,i,s,c){const l=document.createElement("canvas"),m=l.getContext("2d");l.height=u(Math.max(s.frame.ymax-s.frame.ymin,c)),l.width=u(s.frame.xmax-s.frame.xmin);const h=m.createImageData(r,i);h.data.set(new Uint8ClampedArray(t.buffer));const f=this._imageDataToCanvas(h),g=m.createPattern(f,"repeat"),y$1=Math.cos((-e.cim.rotation||0)*Math.PI/180),u$1=Math.sin((-e.cim.rotation||0)*Math.PI/180);g.setTransform({m11:y$1,m12:u$1,m21:-u$1,m22:y$1,m41:u(e.cim.offsetX)||0,m42:u(e.cim.offsetY)||0});const p=s.canvasPaths;let d,M,C;c$2(p)?(d=p.rings,m.fillStyle=g,M=m.fill,C=["evenodd"]):y(p)&&(d=p.paths,m.strokeStyle=g,m.lineWidth=c,M=m.stroke,d[0][0][1]=l.height/2,d[0][1][1]=l.height/2),m.beginPath();for(const o of d){const e=o?o.length:0;if(e>1){let t=o[0];m.moveTo(u(t[0]),u(t[1]));for(let r=1;r<e;++r)t=o[r],m.lineTo(u(t[0]),u(t[1]));m.closePath();}}M.apply(m,C);const I=m.getImageData(0,0,l.width,l.height),z=new Uint8Array(I.data);return {size:[l.width,l.height],image:new Uint32Array(z.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}}_getPictureResource(e,t,r){const i=this._pictureMarkerCache.get(e.materialHash);if(!i)return null;const s=i.height/i.width,o=t?s>1?u(t):u(t)/s:i.width,n=t?s>1?u(t)*s:u(t):i.height;return {image:this._imageTo32Array(i,o,n,r),width:o,height:n}}_embedCIMLayerInVectorMarker(e,t){const r=c$2(t.geometry)?"CIMPolygonSymbol":"CIMLineSymbol",a=t.frame;return {type:"CIMVectorMarker",frame:a,size:a.ymax-a.ymin,markerGraphics:[{type:"CIMMarkerGraphic",geometry:t.geometry,symbol:{type:r,symbolLayers:[e]}}]}}}function x(e){return (e?Object.keys(e):[]).map((t=>({name:t,alias:t,type:"string"==typeof e[t]?"esriFieldTypeString":"esriFieldTypeDouble"})))}function P(e){if(!(e&&e.data&&e.data.symbol))return null;switch(e.data.symbol.type){case"CIMPointSymbol":case"CIMTextSymbol":return "esriGeometryPoint";case"CIMLineSymbol":return "esriGeometryPolyline";case"CIMPolygonSymbol":return "esriGeometryPolygon";default:return null}}function w(e,t,r,a){let i,s;if("function"==typeof e.materialHash){i=(0,e.materialHash)(t,r,a),s=q(e.cim,e.materialOverrides);}else i=e.materialHash,s=e.cim;return {analyzedCIM:s,hash:i}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const o=new z(null,!0),n=120;async function s(t,s={}){const{size:c,maxSize:r,node:m,opacity:f}=s,h=s.cimOptions||s,{feature:y,fieldMap:d,geometryType:p,style:u}=h,g=n$2(t),w=Math.min(null!=c?c:g,null!=r?r:e$1(n));w!==g&&(t=t.clone(),i(t,w,{preserveOutlineWidth:!0}));let M=3;t&&t.data&&t.data.symbol&&"CIMPointSymbol"!==t.data.symbol.type&&(M=1);const b=await o.rasterizeCIMSymbolAsync(t,y,d,p,{scaleFactor:M,style:u}),C=document.createElement("canvas");C.width=b.imageData.width,C.height=b.imageData.height;C.getContext("2d").putImageData(b.imageData,0,0);let D=C.width/M,I=C.height/M;if(null!=c&&(null==(null==s?void 0:s.scale)||(null==s?void 0:s.scale))){const e=D/I;D=e<=1?Math.ceil(w*e):w,I=e<=1?w:Math.ceil(w/e);}const S=new Image(D,I);S.src=C.toDataURL(),null!=f&&(S.style.opacity=`${f}`);let j=S;if(null!=s.effectView){const e={shape:{type:"image",x:0,y:0,width:D,height:I,src:S.src},fill:null,stroke:null,offset:[0,0]};j=l([[e]],[D,I],{effectView:s.effectView});}return m&&m.appendChild(j),j}

export { s as previewCIMSymbol };
