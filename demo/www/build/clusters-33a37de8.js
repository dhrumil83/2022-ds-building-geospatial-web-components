import { dE as u$5, cC as e$1, D as m$4, s as s$6, M as S, R as L, co as a$2, d$ as i$2, e0 as p$4, e1 as J, Z as c$5, Y as i$3, d1 as u$6, a9 as s$7, a6 as c$6, a5 as c$7, T as a$3, e2 as m$5, e3 as e$2, V as r$5, c as s$8, e4 as c$8, bN as j, e5 as a$4 } from './vec2f32-96e18450.js';
import { r as r$4, n as n$3, a as n$4, A } from './shapingUtils-c35082c1.js';
import { s as s$5, b as b$4 } from './definitions-08701efa.js';
import { x as x$3 } from './MD5-6027098a.js';
import { m as m$6 } from './clusterUtils-ccc8af99.js';

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
async function s$4(s,r,m){var f,g,h;const c=r$4("center"),d=n$3("middle"),x=r.textureManager.rasterizeItem(s.toJSON(),window.devicePixelRatio||1,null,m),[,p]=n$4(s.text),u=(await x).glyphMosaicItems;return A(u,p,{angle:null!=(f=s.angle)?f:0,xOffset:u$5(null!=(g=s.xoffset)?g:0),yOffset:u$5(null!=(h=s.yoffset)?h:0),lineHeight:s$5*Math.max(.25,Math.min(s.lineHeight,4)),maxLineWidth:Math.max(32,Math.min(u$5(s.lineWidth),512)),decoration:s.font.decoration,scale:Math.min(Math.round(u$5(s.font.size)),127)/b$4,hAlign:c,vAlign:d,isCIM:!1}).boundsT}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
async function n$2(n,o){await o.when();const r=n.clone();r.text="9";const s=await s$4(r,o),i=4;return e$1(s.width)*i}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const n$1=/^-?(\d+)(\.(\d+))?$/i;function e(t,n){return t-n}function r$3(t,n){let e,r;return e=Number(t.toFixed(n)),e<t?r=e+1/10**n:(r=e,e-=1/10**n),e=Number(e.toFixed(n)),r=Number(r.toFixed(n)),[e,r]}function o$1(t,n,e,r,o){const i=l$1(t,n,e,r),u=null==i.previous||i.previous<=o,s=null==i.next||i.next<=o;return u&&s||i.previous+i.next<=2*o}function i$1(t){const e=String(t),r=e.match(n$1);if(r&&r[1])return {integer:r[1].split("").length,fractional:r[3]?r[3].split("").length:0};if(e.toLowerCase().indexOf("e")>-1){const t=e.split("e"),n=t[0],r=t[1];if(n&&r){const t=Number(n);let e=Number(r);const o=e>0;o||(e=Math.abs(e));const l=i$1(t);return o?(l.integer+=e,e>l.fractional?l.fractional=0:l.fractional-=e):(l.fractional+=e,e>l.integer?l.integer=1:l.integer-=e),l}}return {integer:0,fractional:0}}function l$1(t,n,e,r){const o={previous:null,next:null};if(null!=e){const r=t-e,i=n-e-r;o.previous=Math.floor(Math.abs(100*i/r));}if(null!=r){const e=r-t,i=r-n-e;o.next=Math.floor(Math.abs(100*i/e));}return o}function u$4(t,n={}){const l=t.slice(0),{tolerance:u=2,strictBounds:s=!1,indexes:c=l.map(((t,n)=>n))}=n;c.sort(e);for(let e=0;e<c.length;e++){const t=c[e],n=l[t],a=0===t?null:l[t-1],f=t===l.length-1?null:l[t+1],m=i$1(n).fractional;if(m){let i,c=0,g=!1;for(;c<=m&&!g;){const t=r$3(n,c);i=s&&0===e?t[1]:t[0],g=o$1(n,i,a,f,u),c++;}g&&(l[t]=i);}}return l}const s$3={maximumFractionDigits:20};function c$4(n){return m$4(n,s$3)}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const r$2=s$6.getLogger("esri.renderers.support.utils"),s$2={lte:"<=",gte:">=",lt:"<",gt:">",pct:"%",ld:"â€“"},u$3={millisecond:0,second:1,minute:2,hour:3,day:4,month:5,year:6},d$4={millisecond:"long-month-day-year-long-time",second:"long-month-day-year-long-time",minute:"long-month-day-year-short-time",hour:"long-month-day-year-short-time",day:"long-month-day-year",month:"long-month-day-year",year:"year"},m$3=S("short-date");function f$4(e,n,t){let l="";return 0===n?l=s$2.lt+" ":n===t&&(l=s$2.gt+" "),l+e}function c$3(e){const{values:n,colors:t,labelIndexes:i,isDate:r,dateFormatOptions:s}=e;return n.map(((e,u)=>{let d=null;if(!i||i.indexOf(u)>-1){let t;t=r?L(e,s):c$4(e),t&&(d=f$4(t,u,n.length-1));}return new a$2({value:e,color:t[u],label:d})}))}function p$3(e){const{stops:n,changes:t,isDate:o,dateFormatOptions:r}=e,s=n.map((e=>e.value)),u=[];for(const l of t)u.push(l.index),s[l.index]=l.value;const d=u$4(s,{indexes:u});n.forEach(((e,t)=>{if(e.value=s[t],null!=e.label){let i,s=null;i=o?L(d[t],r):c$4(d[t]),i&&(s=f$4(i,t,n.length-1)),e.label=s;}}));}function h$1(e){let n=e.minValue,t=e.maxValue;const l=e.isFirstBreak?"":s$2.gt+" ",i="percent-of-total"===e.normalizationType?s$2.pct:"";return n=null==n?"":c$4(n),t=null==t?"":c$4(t),l+n+i+" "+s$2.ld+" "+t+i}function y$4(e){const n=e.classBreakInfos,t=e.normalizationType;let l=[];if(n&&n.length)if("standard-deviation"!==e.classificationMethod)if(e.round){l.push(n[0].minValue);for(const e of n)l.push(e.maxValue);l=u$4(l),n.forEach(((e,n)=>{e.label=h$1({minValue:0===n?l[0]:l[n],maxValue:l[n+1],isFirstBreak:0===n,normalizationType:t});}));}else n.forEach(((e,n)=>{e.label=h$1({minValue:e.minValue,maxValue:e.maxValue,isFirstBreak:0===n,normalizationType:t});}));else r$2.warn("setLabelsForClassBreaks","cannot set labels for class breaks generated using 'standard-deviation' method.");}function g$2(e){if("standard-deviation"===e.classificationMethod)return void r$2.warn("updateClassBreak","cannot update labels for class breaks generated using 'standard-deviation' method.");const n=e.classBreaks,t=e.change,l=t.index,a=t.value,i=n.length;let o=-1,s=-1;0===l?o=l:l===i?s=l-1:(s=l-1,o=l);const u=e.normalizationType;let d=null;o>-1&&o<i&&(d=n[o],d.minValue=a,d.label=h$1({minValue:d.minValue,maxValue:d.maxValue,isFirstBreak:0===o,normalizationType:u})),s>-1&&s<i&&(d=n[s],d.maxValue=a,d.label=h$1({minValue:d.minValue,maxValue:d.maxValue,isFirstBreak:0===s,normalizationType:u}));}function x$2(e){const n=e.map((e=>new Date(e))),t=n.length;let l=1/0,a=null;for(let i=0;i<t-1;i++){const e=n[i];let o=1/0,r=null;for(let l=i+1;l<t;l++){const t=n[l],a=(e.getFullYear()!==t.getFullYear()?"year":e.getMonth()!==t.getMonth()&&"month")||e.getDate()!==t.getDate()&&"day"||e.getHours()!==t.getHours()&&"hour"||e.getMinutes()!==t.getMinutes()&&"minute"||e.getSeconds()!==t.getSeconds()&&"second"||"millisecond",i=u$3[a];i<o&&(o=i,r=a);}o<l&&(l=o,a=r);}return a}function V(e){const{value:n,domain:i,fieldInfo:o,dateFormatInterval:r}=e;let s=String(n);const u=i&&"codedValues"in i&&i.codedValues?i.getName(n):null;return u?s=u:"number"==typeof n&&(s=o&&"date"===o.type?L(n,r&&S(d$4[r])):c$4(n)),s}function b$3(e,n){return "normalizationField"in e&&e.normalizationField?F(e.field,e.normalizationField):"field"in e&&e.field?v$2(e.field):"valueExpression"in e&&e.valueExpression?z$1(e.valueExpression,e.valueExpressionTitle,n):null}function v$2(e){return {type:"field",field:e}}function F(e,n){return {type:"normalized-field",field:e,normalizationField:n}}function z$1(e,n,t){return {type:"expression",expression:e,title:n,returnType:t}}function k(n,t){const l=[];if("class-breaks"===n.type||"heatmap"===n.type)l.push(b$3(n,"number"));else if("unique-value"===n.type){const e=n.authoringInfo;if(e&&"relationship"===e.type){if(e.field1&&e.field2){const n=e.field1.field,t=e.field2.field,a=e.field1.normalizationField,i=e.field2.normalizationField;l.push(b$3({field:n,normalizationField:a})),l.push(b$3({field:t,normalizationField:i}));}}else {const e=n.uniqueValueInfos[0];let t=null;if(e&&e.value){const e=typeof n.uniqueValueInfos[0].value;"string"!==e&&"number"!==e||(t=e);}l.push(b$3(n,t)),[n.field2,n.field3].forEach((e=>e&&l.push(v$2(e))));}}else "dot-density"===n.type&&n.attributes.forEach((e=>l.push(b$3(e,"number"))));const a=t?t(n):"visualVariables"in n?n.visualVariables:null;return a&&a.forEach((e=>l.push(b$3(e,"number")))),i$2(l.filter(Boolean),((e,n)=>"field"===e.type&&"field"===n.type?e.field===n.field:"normalized-field"===e.type&&"normalized-field"===n.type?e.field===n.field&&e.normalizationField===n.normalizationField:"expression"===e.type&&"expression"===n.type&&e.expression===n.expression))}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
let m$2=0;const f$3="expression/";function u$2(e){return "hasVisualVariables"in e&&e.hasVisualVariables()?e.visualVariables.filter((e=>!p$4.test(e.valueExpression)&&(!("target"in e)||"outline"!==e.target))):[]}function d$3(e,t){let n=null;"popupTemplate"in e&&e.popupTemplate&&(n=e.popupTemplate.fieldInfos);const s=e.getField(t);let o=null;if(n&&n.some((e=>!(!e||e.fieldName.toLowerCase()!==s.name.toLowerCase())&&(o=e.clone(),!0))),!o){const e=J.indexOf(s.type)>-1,t="integer"===s.type||"small-integer"===s.type;o=new c$5({fieldName:s.name,isEditable:s.editable,visible:!0,format:e?{places:t?0:2,digitSeparator:!0}:null});}return o.label||(o.label=s.alias),o}function c$2(e){const{expression:t,title:n,returnType:i}=e;return new i$3({name:"expr"+m$2++,expression:t,title:n,returnType:i})}function x$1(e){const t="number"===e.returnType?{places:2,digitSeparator:!0}:null;return new c$5({fieldName:`${f$3}${e.name}`,visible:!0,format:t})}async function b$2(i){const s=await u$6("esri/smartMapping/t9n/smartMapping"),{renderer:o,layer:r,normFieldExpressionTemplate:a}=i,p=[],m=[],f=k(o,u$2);for(const e of f)if("field"===e.type)p.push(d$3(r,e.field));else if("normalized-field"===e.type){const t=r.getField(e.field),i=r.getField(e.normalizationField),o=c$2({type:"expression",expression:`\n      $feature["${t.name}"];\n      $feature["${i.name}"];\n      ${"percentage"===a?`($feature["${t.name}"] / $feature["${i.name}"]) * 100;`:`$feature["${t.name}"] / $feature["${i.name}"];`}\n      `,title:s$7("percentage"===a?s.normFieldLabelAsPercent:s.normFieldLabel,{expression1:t.alias,expression2:i.alias}),returnType:"number"});p.push(x$1(o),d$3(r,e.field),d$3(r,e.normalizationField)),m.push(o);}else if("expression"===e.type){const t=c$2(e);p.push(x$1(t)),m.push(t);}return {fieldInfos:i$2(p,((e,t)=>e.fieldName===t.fieldName)),expressionInfos:i$2(m,((e,t)=>e.expression===t.expression))}}async function g$1(e,i){const{fieldInfos:r,expressionInfos:a}=i,l=await u$6("esri/smartMapping/t9n/smartMapping");if(r.length>2)return [new c$6({fieldInfos:r})];const p=[];for(const t of r){const i=t.fieldName;let s=t.label;if(!s){const t=e.getField(i);if(t)s=t.alias||i;else if(a){const e=i.split(f$3)[1],t=a[a.findIndex((t=>t.name===e))];t&&(s=t.title||t.name);}}p.push(new c$7({text:s$7(l.fieldInfo,{fieldLabel:s,fieldValue:`{${i}}`})}));}return p}function y$3(e){return !(!("normalizationField"in e)||!e.normalizationField)||"hasVisualVariables"in e&&e.hasVisualVariables()&&e.visualVariables.some((e=>!(!("normalizationField"in e)||!e.normalizationField)))}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const r$1={light:["streets","gray","topo","terrain","national-geographic","oceans","osm","gray-vector","streets-vector","topo-vector","streets-relief-vector","streets-navigation-vector","arcgis-light-gray","arcgis-navigation","arcgis-streets","arcgis-streets-relief","arcgis-topographic","arcgis-oceans","osm-standard","osm-standard-relief","osm-streets","osm-streets-relief","osm-light-gray","arcgis-terrain","arcgis-charted-territory","arcgis-community","arcgis-colored-pencil","arcgis-modern-antique","arcgis-midcentury","arcgis-newspaper","arcgis-hillshade-light"],dark:["satellite","hybrid","dark-gray","dark-gray-vector","streets-night-vector","arcgis-imagery","arcgis-imagery-standard","arcgis-dark-gray","arcgis-navigation-night","arcgis-streets-night","osm-dark-gray","arcgis-nova","arcgis-hillshade-dark"]},i="percent-of-total",n="field",a$1={years:365,months:30,days:1,hours:1/24,minutes:1/1440,seconds:1/86400,milliseconds:1/864e5},s$1=["integer","small-integer"];let o=null;async function c$1(t){const r=t.field,i=t.normalizationField,n=t.valueExpression;let a=[];if(n){if(!o){const{arcadeUtils:t}=await a$3();o=t;}a=o.extractFieldNames(n);}return r&&a.push(r),i&&a.push(i),a}function g(e){let t=e.normalizationType;return t||(e.normalizationField?t=n:null!=e.normalizationTotal&&(t=i)),t}function l(e){return String(e).padStart(2,"0")}function u$1(e,t,r){let i;if("date"===t||"number"===t){"number"===t&&(e=new Date(e));i=`TIMESTAMP'${r?e.getFullYear():e.getUTCFullYear()}-${l((r?e.getMonth():e.getUTCMonth())+1)}-${l(r?e.getDate():e.getUTCDate())} ${l(r?e.getHours():e.getUTCHours())}:${l(r?e.getMinutes():e.getUTCMinutes())}:${l(r?e.getSeconds():e.getUTCSeconds())}'`;}else i=e;return i}function d$2(e,t,r,i){const{hasQueryEngine:n}=e;let s=`(${u$1(r,f$2(e,r),n)} - ${u$1(t,f$2(e,t),n)})`;n&&(s=`(${s} * ${a$1.milliseconds})`);let o=a$1[i],c="/";o<1&&(o=1/o,c="*");return {sqlExpression:1===o?s:`(${s} ${c} ${o})`,sqlWhere:null}}function f$2(e,t){if(t instanceof Date)return "date";if("number"==typeof t)return "number";if("string"==typeof t){const r=e.getField(t);if("<now>"===t.toLowerCase())return;if(r&&"date"===r.type)return "field"}}function m$1(e,t=r$1){for(const r in t)if(t[r].indexOf(e)>-1)return r}function p$2(e,r,i=!0){let n=null;return e&&("string"==typeof e?r.includes(e)&&(n=e):n=m$5(e)),i?n||"gray":n}function y$2(e,t){const r=t&&e.getField(t);return r&&s$1.indexOf(r.type)>-1}function h(e){return `cast(${e} as float)`}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const r="cluster_count";function a(n,e){return n.split(`cluster_${e}_`).pop()}function s(n){if(!n)return null;const{field:e,valueExpression:i,normalizationField:o,normalizationType:r,normalizationTotal:a}=n;let s=null;if(i)s=i;else if(e){const n=g({normalizationType:r,normalizationField:o,normalizationTotal:a});if(n){const i=n.toLowerCase();if(s=e.toLowerCase()+",norm:"+i,o)s+=","+o.toLowerCase();else if("percent-of-total"===i){let n=a;e$2(n)&&0!==n||(n=null),s+=","+n;}}}return s}function u(n){return x$3(n)}function p$1(n,i){const t=s(n);return `${i}_${r$5(t)?u(t):n.field}`}function f$1(n,e){return `cluster_${p$1(n,e)}`}function c(n,e){const i=e.getField(n);return i&&i.type}function m(n,i){const t="field"in i&&i.field,o=t?c(t,n):null;return {field:t,fieldType:r$5(o)?o:null,valueExpression:"valueExpression"in i?i.valueExpression:null,valueExpressionTitle:"valueExpressionTitle"in i?i.valueExpressionTitle:null,normalizationField:"normalizationField"in i?i.normalizationField:null,normalizationType:"normalizationType"in i?i.normalizationType:null,normalizationTotal:"normalizationTotal"in i?i.normalizationTotal:null}}function v$1(n,i){const t="rotation"===i.type?i.rotationType:null,o=i.legendOptions&&i.legendOptions.title,l=i.field,r=l?c(l,n):null;return {field:l,fieldType:r$5(r)?r:null,rotationType:t,valueExpression:i.valueExpression,valueExpressionTitle:i.valueExpressionTitle||i.valueExpression&&o,normalizationField:"normalizationField"in i?i.normalizationField:null,vvType:i.type}}function T(n){return n.map((n=>`{\n        "value": "${String(n.value)}",\n        "label": "${d$1(String(n.label))}"\n      }`))}function d$1(n){return n?n.replace(/"/g,'\\"'):""}function y$1(n,e,i){return `\n  var uvInfos = [${T(n).join(", ")}];\n  var predominantType = Text($feature["${e}"]);\n  var label = "${d$1(i)}";\n\n  for (var i = 0; i < Count(uvInfos); i++) {\n    if (uvInfos[i].value == predominantType) {\n      label = uvInfos[i].label;\n      break;\n    }\n  }\n\n  return label;\n  `}function z(n,e){const i=[p$1(n,e)];return "date"===n.fieldType&&i.push(n.fieldType.toLowerCase()),n.rotationType&&i.push(n.rotationType.toLowerCase()),i.join("_")}function x(n,e){return {statisticHash:z(n,e),attributeInfo:n,statisticType:e}}function b$1(e,i,t=!0){const l=[],r=m(e,i);"class-breaks"===i.type?l.push(x(r,"avg")):"unique-value"===i.type&&l.push(x(r,"type"));const a=u$2(i);for(const n of a){const i=v$1(e,n);l.push(x(i,"avg"));}return t?i$2(l,((n,e)=>n.statisticHash===e.statisticHash)):l}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
async function f(n){const{layer:t,renderer:r,view:s}=n;await Promise.all([t.load(),s.when()]);const o=r||t.renderer;return m$6(o)?{layer:t,renderer:o,view:s}:Promise.reject(new s$8("clusters-label-schemes:invalid-parameters","'renderer' is not valid"))}function p(e,n,t){const r="unique-value"===e.type?e.uniqueValueInfos:[];return y$1(r,n,t)}function v(e){return `\n  $feature["${e}"];\n  var value = $feature["${e}"];\n  var num = Count(Text(Round(value)));\n  var label = When(\n    num < 4, Text(value, "#.#"),\n    num == 4, Text(value / Pow(10, 3), "#.0k"),\n    num <= 6, Text(value / Pow(10, 3), "#k"),\n    num == 7, Text(value / Pow(10, 6), "#.0m"),\n    num > 7, Text(value / Pow(10, 6), "#m"),\n    Text(value, "#,###")\n  );\n  return label;\n  `}function w(e){const n=new c$8({haloColor:"#373837",haloSize:"1px",color:"#f0f0f0",font:{family:"Noto Sans",size:"12px",weight:"bold"}});return new j({symbol:n,deconflictionStrategy:"none",labelPlacement:"center-center",labelExpressionInfo:new a$4({expression:e})})}async function y(e){const{renderer:n,view:t,statInfo:r$1}=e,o=null==r$1?void 0:r$1.statisticType,l=r$1?f$1(r$1.attributeInfo,o):r,c=w("type"===o?p(n,l,e.noneValueLabel):v(l));return {name:r$1?`clusters-${o}-${a(l,o)}`:"clusters-count",labelingInfo:[c],clusterMinSize:await n$2(c.symbol,t),fieldName:l}}function b(e){const n=new Map;for(const t of e)"size"===t.attributeInfo.vvType?n.set(t.statisticHash,t):n.has(t.statisticHash)||n.set(t.statisticHash,t);return [...n.values()]}async function d(e){const[{renderer:t,layer:r,view:s},a]=await Promise.all([f(e),u$6("esri/smartMapping/t9n/smartMapping")]);if(!t)return null;let i=null;const l=[],u=b(b$1(r,t,!1));for(const n of u){const e=await y({renderer:t,view:s,statInfo:n,noneValueLabel:a.clusters.predominantNoneValue});"size"===n.attributeInfo.vvType?i=e:l.push(e);}const c=await y({renderer:t,view:s});return i?l.unshift(c):i=c,{primaryScheme:i,secondarySchemes:l}}

export { d };
